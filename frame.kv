#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import FadeTransition kivy.uix.screenmanager.FadeTransition

# Set colors
#:set metricBackground get_color_from_hex("#0D1117")
#:set darkGray get_color_from_hex("#212121")
#:set lightGray get_color_from_hex("#718089")
#:set darkBlue get_color_from_hex("#155075") 
#:set lightBlue get_color_from_hex("#2b96d4")
#:set orange get_color_from_hex("#F7C14C")
#:set white get_color_from_hex("#FFFFFF")
#:set black get_color_from_hex("#000000")

# Set Variables
#: set card_elevation 20
#: set topMetrics 50
#: set subtext_height 0.2
#: set topIconSize 30
#: set supportTextHeight 0.20
#: set abstract1 './assets/abstract1.jpg' 

#===================== HISTORY ENTRY RULE

<HistoryEntry>:
    md_bg_color: darkBlue
    size_hint_y: None    
    height: 125

    # Box for Content
    MDBoxLayout:

        orientation: 'vertical'
        size_hint_x: 0.8

        # Box for ID
        MDBoxLayout:
            size_hint_y: 0.25
            md_bg_color: darkBlue
            padding: [15,5]
            
            MDLabel:
                font_style: 'Button'
                text: 'Report ID: ' + str(root.data.id)
                color: white

        # Box for Additional Details
        MDBoxLayout:
            size_hint_y: 0.75
            md_bg_color: darkGray

            MDBoxLayout:
                size_hint_x: 0.7
                orientation: 'vertical'
                md_bg_color: darkGray
                
                padding: [15,5]

                MDLabel:
                    font_style: 'Button'
                    text: 'Name: ' + str(root.data.name)
                    color: white
                
                MDLabel:
                    font_style: 'Button'
                    text: 'Timestamp: ' + str(root.data.date)
                    color: white

                MDLabel:
                    font_style: 'Button'
                    text: 'Progress: ' + str(root.data.progress)
                    color: white


            MDBoxLayout:
                size_hint_x: 0.3
                orientation: 'vertical'
                md_bg_color: darkGray

                padding: [15,5]

                MDLabel:
                    font_style: 'Button'
                    text: 'Host Count: ' + str(root.data.hostCount)
                    color: white
                
                MDLabel:
                    font_style: 'Button'
                    text: 'Vuln Count: ' +  str(root.data.vulnCount)
                    color: white

                MDLabel:
                    font_style: 'Button'
                    text: 'CVSS Base: ' +  str(root.data.severity)
                    color: white

            # Box for Button                            
            MDBoxLayout:
                md_bg_color: darkGray     
                size_hint_x: 0.2

                AnchorLayout:
                    # Button for Scanning
                    MDRectangleFlatIconButton:
                        icon: 'skull-scan-outline'
                        theme_text_color: "Custom"
                        text_color: orange
                        line_color: orange
                        theme_icon_color: "Custom"
                        icon_color: orange
                        text: '[b]View Report[/b]'
                        line_width: 1.5
                        on_release: root.viewReport()

# =================== Safe Content
<SafePanel>
    orientation: 'vertical'
    size_hint: 1, None
    md_bg_color: black
    padding: 15
    spacing: 15

    MDBoxLayout:
        orientation: 'vertical'

        MDBoxLayout:
            MDIcon:
                icon: 'shield-check'
                halign: 'center'
                theme_text_color: "Custom"
                text_color: orange
                font_size: 40

        MDBoxLayout:
            MDLabel:
                markup: True
                text: '[b]This Host is Safe [/b]'
                halign: 'center'
                theme_text_color: "Custom"
                text_color: orange
                font_size: 20

# =================== MyContent
<MyContent>:
    orientation: 'vertical'
    size_hint: 1, None
    height: self.minimum_height
    md_bg_color: black
    padding: (5,5)
    spacing: 10

#===================== Host Panel
<VulnPanel>:
    size_hint: 1, None
    height: upperBox.height + lowerBox.height
    orientation: "vertical"

    # Upper Box for Primary vulnerability Data
    MDBoxLayout:
        id: upperBox
        size_hint: 1, None
        md_bg_color: darkGray

        # Left Box
        MDBoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.6
            spacing: 5
            padding: [0,10]
            # Box for Vuln Description
            MDBoxLayout:
                orientation: 'horizontal'
                padding: [10,5]

                MDBoxLayout:
                    size_hint_x: 0.25
                    MDLabel:
                        theme_text_color: "Custom"
                        text_color: white
                        markup: True
                        text: '[b]Description: [/b]' 
                MDBoxLayout:
                    size_hint_x: 0.75
                    MDLabel:
                        theme_text_color: "Custom"
                        text_color: white
                        halign: 'left'
                        text: str(root.data.name)

            # Box for Threat Family 
            MDBoxLayout:
                orientation: 'horizontal'
                padding: [10,5]

                MDBoxLayout:
                    size_hint_x: 0.25
                    MDLabel:
                        theme_text_color: "Custom"
                        text_color: white
                        markup: True
                        text: '[b]Threat Family: [/b]' 
                MDBoxLayout:
                    size_hint_x: 0.75
                    MDLabel:
                        theme_text_color: "Custom"
                        text_color: white
                        halign: 'left'
                        text: str(root.data.threatFamily)

            # Box for Solution Type 
            MDBoxLayout:
                orientation: 'horizontal'
                padding: [10,5]

                MDBoxLayout:
                    size_hint_x: 0.25
                    MDLabel:
                        markup: True
                        text: '[b]Solution Type: [/b]'
                        theme_text_color: "Custom"
                        text_color: white

                MDBoxLayout:
                    size_hint_x: 0.75
                    
                    MDIcon:
                        size_hint_x: None
                        width: self.texture_size[1]
                        icon: root.data.solutionIcon
                        theme_text_color: 'Custom'
                        text_color: white
                        halign: 'left'
                    
                    MDLabel:
                        markup: True
                        id: solutionType
                        text: '  ' + str(root.data.solution['@type']) 
                        theme_text_color: "Custom"
                        text_color: white

        # Right Box
        MDBoxLayout:
            orientation: 'vertical'
            size_hint_x: 0.4
            spacing: 5
            padding: [0,10]


            # Box for Vector
            MDBoxLayout:
                orientation: 'horizontal'
                padding: [10,5]

                MDBoxLayout:
                    size_hint_x: 0.25
                    MDLabel:
                        markup: True
                        text: '[b]Vector: [/b]' 
                        theme_text_color: "Custom"
                        text_color: white
                MDBoxLayout:

                    size_hint_x: 0.75
                    MDLabel:
                        theme_text_color: "Custom"
                        text_color: white
                        halign: 'left'
                        text: str(root.data.vector)

            # Box for Quality detection
            MDBoxLayout:
                orientation: 'horizontal'
                padding: [10,5]

                MDBoxLayout:
                    size_hint_x: 0.25
                    MDLabel:
                        theme_text_color: "Custom"
                        text_color: white
                        markup: True
                        text: '[b]Reliability: [/b]' 
                MDBoxLayout:
                    size_hint_x: 0.75
                    MDLabel:
                        theme_text_color: "Custom"
                        text_color: white
                        halign: 'left'  
                        text: str(root.data.qod)

            
            # Box for Risk Score
            MDBoxLayout:
                orientation: 'horizontal'
                padding: [10,5]
                
                MDBoxLayout:
                    size_hint_x: 0.25
                    MDLabel:
                        markup: True
                        text: '[b]Risk Score: [/b]'
                        theme_text_color: "Custom"
                        text_color: white

                MDBoxLayout:
                    size_hint_x: 0.75
                    MDLabel:
                        markup: True
                        id: solutionType
                        text: str(root.data.risk)
                        theme_text_color: "Custom"
                        text_color: white
    
    # Solution Description
    MDBoxLayout:
        id: lowerBox
        orientation: "vertical"
        md_bg_color: darkGray
        size_hint: 1, None
        padding: [10,5]

        MDLabel:
            markup: True
            height: self.texture_size[1]
            id: solutionDescription
            text: '[b]Solution Description:  [/b]' + str(root.data.solution['#text'])
            theme_text_color: "Custom"
            text_color: orange


#===================== REPORT DASHBOARD ENTRY RULE

<ReportDashboard>:

    ScrollView:
        do_scroll_y: True

        MDGridLayout:
            adaptive_height: True
            rows: 2
            cols: 1 
            size_hint_x: 1.0
            size_hint_y: None
            height: self.minimum_height

            # Upper Box for Displaying 3 Cards of Top 3 Metrics
            MDGridLayout:
                rows: 1
                cols: 3
                size_hint_y: None
                height: root.height*0.6
                padding: 35
                spacing: 35
                                        
                # Card for Count of Severe Vulnerabilities
                MDCard:
                    elevation: card_elevation
                    orientation: "vertical"
                    md_bg_color: darkGray

                    MDLabel:
                        markup: True
                        halign: 'center'
                        theme_text_color: 'Custom'
                        text_color: orange
                        font_size: topMetrics
                        text: '[b]' + str(root.data.highRiskVulnCount) + '[/b]'

                    MDLabel:
                        markup: True
                        size_hint_y: supportTextHeight
                        halign: 'center'
                        theme_text_color: 'Custom'
                        text_color: white
                        text: 'Out of [b]' + str(root.data.totalVulnerabilities) +  '[/b] vulnerabilities found'


                    # Footer
                    MDBoxLayout:
                        size_hint_y: subtext_height
                        md_bg_color: darkBlue

                        MDIcon:
                            icon: 'biohazard'
                            size_hint_x: 0.3
                            theme_text_color: 'Custom'
                            font_size: topIconSize
                            text_color: white
                            halign: 'center'

                        MDLabel:
                            size_hint_x: 0.7
                            halign: 'left'
                            font_style: 'Button'
                            theme_text_color: 'Custom'
                            text_color: white
                            text: 'Severe vulnerabilities Count'

                # Card for Aggregated Network Score
                MDCard:
                    elevation: card_elevation
                    orientation: "vertical"
                    md_bg_color: darkGray

                    MDLabel:
                        markup: True
                        halign: 'center'
                        theme_text_color: 'Custom'
                        text_color: orange
                        font_size: topMetrics
                        text:  '[b]' + str(root.data.aggregatedRisk)  + '[/b]'

                    MDLabel:
                        markup: True
                        size_hint_y: supportTextHeight
                        halign: 'center'
                        theme_text_color: 'Custom'
                        text_color: white
                        text: root.data.assessment

                    # Footer
                    MDBoxLayout:
                        size_hint_y: subtext_height
                        md_bg_color: darkBlue

                        MDIcon:
                            icon: 'security'
                            size_hint_x: 0.3
                            font_size: topIconSize
                            theme_text_color: 'Custom'
                            text_color: white
                            halign: 'center'

                        MDLabel:
                            size_hint_x: 0.7
                            halign: 'left'
                            theme_text_color: 'Custom'
                            text_color: white
                            font_style: 'Button'
                            text: 'Aggregated Network Score'

                # Card for Most Compromised Host 
                MDCard:
                    elevation: card_elevation
                    orientation: "vertical"
                    md_bg_color: darkGray

                    MDLabel:
                        markup: True
                        halign: 'center'
                        theme_text_color: 'Custom'
                        text_color: orange
                        font_size: topMetrics
                        text: '[b]' + str(root.data.mostVulnerableHost) + '[/b]'

                    MDLabel:
                        markup: True
                        theme_text_color: 'Custom'
                        text_color: white
                        size_hint_y: supportTextHeight
                        halign: 'center'
                        text: 'Among the [b]' + str(root.data.hostCount) + '[/b] hosts found'  

                    # Footer
                    MDBoxLayout:
                        size_hint_y: subtext_height
                        md_bg_color: darkBlue

                        MDIcon:
                            icon: 'ip-network'
                            size_hint_x: 0.3
                            font_size: topIconSize
                            theme_text_color: 'Custom'
                            text_color: white
                            halign: 'center'

                        MDLabel:
                            size_hint_x: 0.7
                            markup: True
                            halign: 'left'
                            font_style: 'Button'
                            text: 'Most Compromised Host'
                            theme_text_color: 'Custom'
                            text_color: white
                
            # Lower Box for Additional Data
            MDGridLayout:
                cols: 1
                adaptive_height: True
                id: additionalData
                md_bg_color: darkBlue


#===================== MAIN RULE

MDBoxLayout:
    orientation: 'vertical'

    MDToolbar:
        title: "[b]Title ng SP KO[/b]"
        md_bg_color: darkBlue
        left_action_items: [["menu", lambda x: app.openRail()]]

    MDBoxLayout:

        MDNavigationRail:
            id: rail
            use_resizeable: True
            md_bg_color: darkGray

            color_normal: lightGray
            color_active: orange

            use_hover_behavior: True
            hover_bg: 0, 0, 0, .3

            MDNavigationRailItem:
                icon: 'view-dashboard'
                text: '[b]Dashboard[/b]'
                on_release:
                    screenManager.current = "dashboardScreen"

            MDNavigationRailItem:
                icon: 'cube-scan'
                text: '[b]Scan[/b]'
                on_release:
                    screenManager.current = "scanScreen"

            MDNavigationRailItem:
                icon: 'clipboard-clock-outline'
                text: '[b]History[/b]'
                on_release:
                    screenManager.current = "historyScreen"
                    app.generateHistoryEntries()
            
            MDNavigationRailItem:
                icon: 'calculator-variant'
                text: '[b]Risk Calculator[/b]'
                on_release:
                    screenManager.current = "calculatorScreen"
  
                    
            MDNavigationRailItem:
                icon: 'exit-to-app'
                text: '[b]Exit[/b]'
                on_release:
                    app.stop()

        MDBoxLayout:
            orientation: 'vertical'

            ScreenManager:
                id: screenManager

                # Screen for Dashboard
                MDScreen:
                    name: "dashboardScreen"
                    md_bg_color: black

                    # Box Containing Report Data, attach ReportDashboard here
                    MDBoxLayout:
                        id: reportBox
                        md_bg_color: black

                        AnchorLayout:
                            MDBoxLayout:
                                size_hint_y: 0.25
                                orientation: 'vertical'
                                spacing: 20
                                
                                MDIcon:
                                    icon: 'alert-octagon'
                                    halign: 'center'
                                    theme_text_color: "Custom"
                                    text_color: orange
                                    font_size: 70
                                MDLabel:
                                    markup: True
                                    font_size: 50
                                    text: '[b]No Report Generated Yet[/b]'
                                    halign: 'center'
                                    theme_text_color: 'Custom'
                                    text_color: orange

                # Screen for Scan
                MDScreen:
                    id: scanScreen
                    name: "scanScreen"
                    MDLabel:
                        halign: 'center'
                        text: "Scan Screen here"

                # Screen for History
                MDScreen:
                    name: "historyScreen"
                    md_bg_color: black

                    # For scroling through history entries
                    ScrollView:
                        do_scroll_y: True
                        
                        # Grid Containing History Entries 
                        MDGridLayout:
                            id: historyGrid
                            adaptive_height: True
                            size_hint_x: 1.0     
                            size_hint_y: None    
                            cols: 1
                            padding: 50
                            spacing: 30
                            

                # Screen for CVE Risk Calculator 
                MDScreen:
                    name: "calculatorScreen"
                    MDLabel:
                        halign: 'center'
                        text: "CVE Risk Calculator Here"